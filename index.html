<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>KemiTech Supplies Limited</title>
<meta name="description" content="Offline inventory system with sales history, stock movement history, expenses, date-based summaries, and cloud sync." />
<style>
:root{--p:#44033f;--d:#c0392b;--bg:#ec94e5;--c:#fff}
*{box-sizing:border-box;font-family:system-ui,sans-serif}
body{margin:0;background:var(--bg)}
header{background:var(--p);color:#fff;padding:1rem 2rem}
main{padding:2rem;max-width:1500px;margin:auto}
.card{background:var(--c);padding:1.5rem;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.08);margin-bottom:1.5rem}
.grid{display:grid;grid-template-columns:1fr 2fr;gap:2rem}
label{display:block;margin-top:.6rem}
input,select{width:100%;padding:.5rem;margin-top:.3rem}
button{margin-top:1rem;padding:.5rem 1rem;border:0;border-radius:6px;cursor:pointer}
.primary{background:var(--p);color:#fff}
.danger{background:var(--d);color:#fff}
table{width:100%;border-collapse:collapse;margin-top:.5rem}
th,td{padding:.5rem;border-bottom:1px solid #ddd;font-size:.9rem}
.small{font-size:.8rem;color:#666}
.flex{display:flex;gap:1rem;flex-wrap:wrap}
footer{padding:1rem;text-align:center;color:#fff;background:var(--p);cursor:pointer}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- LOCK SCREEN -->
<div id="lock" style="position:fixed;inset:0;background:var(--p);display:flex;align-items:center;justify-content:center;z-index:9999">
 <div style="background:#fff;padding:2rem;border-radius:10px;max-width:320px;width:100%">
  <h3>KemiTech Login</h3>
  <input type="password" id="pwd" placeholder="Password">
  <button class="primary" style="width:100%" onclick="unlock()">Unlock</button>
 </div>
</div>

<header><h1>KemiTech Supplies Limited</h1></header>
<main>

<!-- CAPITAL & NET WORTH -->
<div class="card" style="display:flex;justify-content:space-between;gap:1rem;">
  <div style="flex:1;background:#f0f0f0;border:2px solid #2b9b4c;border-radius:10px;padding:1rem;text-align:center;">
    <p><strong>Capital</strong></p>
    <p style="font-size:1.5rem;color:#2b9b4c" id="capital">0</p>
  </div>
  <div style="flex:1;background:#f0f0f0;border:2px solid #c0392b;border-radius:10px;padding:1rem;text-align:center;">
    <p><strong>Net Worth</strong></p>
    <p style="font-size:1.5rem;color:#c0392b" id="networth">0</p>
  </div>
</div>

<!-- ADD / RESTOCK -->
<div class="grid">
<div class="card">
<h3>Add / Restock Product</h3>
<label>Search Existing Product<input id="psearch" oninput="fillProduct()"></label>
<label>Product Name<input id="pname"></label>
<label>Buy Price<input id="buy" type="number"></label>
<label>Sell Price<input id="sell" type="number"></label>
<label>Quantity<input id="stock" type="number"></label>
<button id="saveBtn" class="primary" onclick="addOrRestock()">Save</button>
<p class="small">Existing product = restock. New name = create product.</p>
</div>

<!-- PRODUCTS -->
<div class="card">
<h3>Products & Stock History</h3>
<label>Search<input id="search" oninput="render()"></label>
<select id="sumRange" onchange="render()">
<option value="all">All Time</option>
<option value="day">Today</option>
<option value="week">This Week</option>
<option value="month">This Month</option>
</select>
<table>
<thead><tr><th>Product</th><th>Stock</th><th>Last Update</th><th>Stock Movement History</th><th>Remove</th></tr></thead>
<tbody id="products"></tbody>
</table>
</div>
</div>

<!-- SALES -->
<div class="card">
<h3>Record Sale</h3>
<label>Product<select id="sellProduct"></select></label>
<label>Quantity<input id="sellQty" type="number"></label>
<button id="sellBtn" class="primary" onclick="sellItem()">Record Sale</button>
</div>

<div class="card">
<h3>Sales History</h3>
<div class="flex">
<input id="saleSearch" placeholder="Search product" oninput="render()">
<select id="saleRange" onchange="render()">
<option value="all">All</option>
<option value="day">Today</option>
<option value="week">This Week</option>
<option value="month">This Month</option>
</select>
</div>
<table>
<thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>Revenue</th><th>Profit</th></tr></thead>
<tbody id="sales"></tbody>
</table>
</div>

<!-- EXPENSES -->
<div class="card">
<h3>Expenses</h3>
<div class="flex">
<input id="expDesc" placeholder="Description">
<input id="expAmt" type="number" placeholder="Amount">
<button id="expBtn" class="danger" onclick="addExpense()">Add</button>
</div>
<select id="expRange" onchange="render()">
<option value="all">All</option>
<option value="day">Today</option>
<option value="week">This Week</option>
<option value="month">This Month</option>
</select>
<table>
<thead><tr><th>Date</th><th>Description</th><th>Amount</th></tr></thead>
<tbody id="expenses"></tbody>
</table>
</div>

<!-- SUMMARY -->
<div class="card">
<h3>Summary</h3>
<select id="summaryRange" onchange="render()">
<option value="all">All Time</option>
<option value="day">Today</option>
<option value="week">This Week</option>
<option value="month">This Month</option>
</select>
<p><strong>Available Cash:</strong> <span id="cash">0</span></p>
<p>Revenue: <span id="rev">0</span></p>
<p>Expenses: <span id="exp">0</span></p>
<p><strong>Net Profit:</strong> <span id="profit">0</span></p>
</div>

<!-- EXPORT -->
<div class="card">
<h3>Export</h3>
<button class="primary" onclick="exportCSV('products')">Export Products</button>
<button class="primary" onclick="exportCSV('sales')">Export Sales</button>
<button class="primary" onclick="exportCSV('expenses')">Export Expenses</button>
</div>

<!-- ADMIN PANEL -->
<div class="card" id="adminPanel" style="display:none">
<h3>ADMIN ONLY</h3>
<button class="danger" onclick="adminResetLocal()">Reset LOCAL Data</button>
<button class="danger" onclick="adminDeleteShared()">Delete SHARED Data</button>
<button class="danger" onclick="adminResetApp()">Reset ENTIRE App</button>
</div>

</main>
<script>
const ADMIN_PASSWORD = "nonstop@24";
const USER_PASSWORD  = "money@2026";

let role = null;

const GIST_ID='a17292402f076ba0c5531f4144ef71b';
const GITHUB_TOKEN='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';
const GIST_FILE = "kemitech-db.json";

let db = { products: [], sales: [], expenses: [] };

function today(){
  return new Date().toISOString().split('T')[0];
}

/* ================= INIT ================= */

function initDB(){
  const local = localStorage.getItem("KEMITECH_DB");
  if(local){
    db = JSON.parse(local);
  }
  render();
}

/* ================= LOGIN ================= */

function unlock(){
  if(pwd.value === ADMIN_PASSWORD){
    role = "admin";
  }
  else if(pwd.value === USER_PASSWORD){
    role = "user";
  }
  else{
    alert("Wrong password");
    return;
  }

  lock.style.display = "none";
  applyRoleUI();
  loadFromGist();
}

/* ================= ROLE ================= */

function applyRoleUI(){
  document.getElementById("adminPanel").style.display =
  role === "admin" ? "block" : "none";


  document.querySelectorAll('.admin-only')
    .forEach(el => el.style.display = role === "admin" ? "block" : "none");

  const allowEdit = true; // both admin and user can add

  document.getElementById('pname').readOnly = !allowEdit;
  document.getElementById('buy').readOnly = !allowEdit;
  document.getElementById('sell').readOnly = !allowEdit;
  document.getElementById('stock').readOnly = !allowEdit;
  document.getElementById('saveBtn').disabled = !allowEdit;

  document.getElementById('sellProduct').disabled = !allowEdit;
  document.getElementById('sellQty').readOnly = !allowEdit;
  document.getElementById('sellBtn').disabled = !allowEdit;

  document.getElementById('expDesc').readOnly = !allowEdit;
  document.getElementById('expAmt').readOnly = !allowEdit;
  document.getElementById('expBtn').disabled = !allowEdit;
}

/* ================= RANGE ================= */

function inRange(d,r){
  const t=new Date(d), n=new Date();
  if(r==='day') return t.toDateString()===n.toDateString();
  if(r==='week') return (n-t)/86400000<=7;
  if(r==='month') return t.getMonth()===n.getMonth() && t.getFullYear()===n.getFullYear();
  return true;
}

/* ================= PRODUCTS ================= */

function addOrRestock(){
  const name = pname.value.trim();
  const qty = +stock.value;
  if(!name || qty<=0) return;

  let p = db.products.find(x => x.name.toLowerCase()===name.toLowerCase());

  if(p){
    p.stock += qty;
    p.history.push({d:today(), q:qty});
  }else{
    db.products.push({
      name,
      buy:+buy.value,
      sell:+sell.value,
      stock:qty,
      history:[{d:today(), q:qty}]
    });
  }

  clearProductForm();
  saveToCloud();

  function clearProductForm(){
  pname.value="";
  buy.value="";
  sell.value="";
  stock.value="";
  psearch.value="";
}

}

function removeProduct(i){
  if(role !== "admin"){
    alert("Admin only");
    return;
  }
  db.products.splice(i,1);
  saveToCloud();
}

/* ================= SALES ================= */

function sellItem(){
  const p = db.products[sellProduct.value];
  const q = +sellQty.value;

  if(!p || q<=0 || q>p.stock){
    alert("Invalid sale");
    return;
  }

  p.stock -= q;
  p.history.push({d:today(), q:-q});

  db.sales.unshift({
    d:today(),
    n:p.name,
    q,
    r:q*p.sell,
    prof:q*(p.sell-p.buy)
  });

  sellQty.value="";
  saveToCloud();
}

/* ================= EXPENSES ================= */

function addExpense(){
  const amt = +expAmt.value;
  if(amt<=0) return;

  db.expenses.unshift({
    d:today(),
    n:expDesc.value,
    a:amt
  });

  expDesc.value="";
  expAmt.value="";
  saveToCloud();
}

/* ================= RENDER ================= */

function render(){

  products.innerHTML="";
  sales.innerHTML="";
  expenses.innerHTML="";
  sellProduct.innerHTML="";

  /* ================= PRODUCTS ================= */

  db.products.forEach((p,i)=>{

    products.innerHTML += `
    <tr>
      <td>${p.name}</td>
      <td>${p.stock}</td>
      <td>${p.history?.at(-1)?.d||''}</td>
      <td>${p.history?.map(h=>h.q).join("<br>")||''}</td>
      <td class="admin-only">
        <button class="danger" onclick="removeProduct(${i})">X</button>
      </td>
    </tr>`;

    sellProduct.innerHTML += `<option value="${i}">${p.name}</option>`;
  });

  /* ================= SALES ================= */

  db.sales.forEach(s=>{
    sales.innerHTML += `
    <tr>
      <td>${s.d}</td>
      <td>${s.n}</td>
      <td>${s.q}</td>
      <td>${s.r}</td>
      <td>${s.prof}</td>
    </tr>`;
  });

  /* ================= EXPENSES ================= */

  db.expenses.forEach(e=>{
    expenses.innerHTML += `
    <tr>
      <td>${e.d}</td>
      <td>${e.n}</td>
      <td>${e.a}</td>
    </tr>`;
  });

  /* ================= CAPITAL & NET WORTH ================= */

  let capital=0;
  let net=0;

  db.products.forEach(p=>{
    capital += p.stock * p.buy;
    net += p.stock * p.sell;
  });

  document.getElementById("capital").textContent = capital.toFixed(2);
  document.getElementById("networth").textContent = net.toFixed(2);

  /* ================= SUMMARY ================= */

  const range = summaryRange.value;

  const filteredSales = db.sales.filter(s=>inRange(s.d,range));
  const filteredExpenses = db.expenses.filter(e=>inRange(e.d,range));

  const revenue = filteredSales.reduce((t,x)=>t+x.r,0);

  const cost = filteredSales.reduce((t,x)=>{
    const product = db.products.find(p=>p.name===x.n);
    return t + (product ? x.q * product.buy : 0);
  },0);

  const expense = filteredExpenses.reduce((t,x)=>t+x.a,0);

  const netProfit = revenue - cost - expense;
  const availableCash = revenue - expense;

  document.getElementById("rev").textContent = revenue.toFixed(2);
  document.getElementById("exp").textContent = expense.toFixed(2);
  document.getElementById("profit").textContent = netProfit.toFixed(2);
  document.getElementById("cash").textContent = availableCash.toFixed(2);

  localStorage.setItem("KEMITECH_DB", JSON.stringify(db));
  applyRoleUI();
  async function loadFromGist(){

  try{
    const res = await fetch(`https://api.github.com/gists/${GIST_ID}`,{
      headers:{ Authorization:`Bearer ${GITHUB_TOKEN}` }
    });

    const data = await res.json();

    if(data.files && data.files[GIST_FILE]){

      const cloudDB = JSON.parse(data.files[GIST_FILE].content || '{}');

      if(cloudDB.products){
        db = cloudDB;
        localStorage.setItem("KEMITECH_DB", JSON.stringify(db));
      }
    }

    render();

  }catch(e){
    console.log("Cloud load failed. Using local.");
    render();
  }
}
async function adminDeleteShared(){
  if(role!=="admin") return alert("Admin only");

  const confirmDelete = prompt("Type DELETE to confirm:");
  if(confirmDelete !== "DELETE") return;

  db={products:[],sales:[],expenses:[]};

  await fetch(`https://api.github.com/gists/${GIST_ID}`,{
    method:"PATCH",
    headers:{
      Authorization:`Bearer ${GITHUB_TOKEN}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      files:{
        [GIST_FILE]:{
          content:JSON.stringify(db,null,2)
        }
      }
    })
  });

  localStorage.removeItem("KEMITECH_DB");
  render();
}

}


async function saveToCloud(){

  localStorage.setItem("KEMITECH_DB", JSON.stringify(db));

  await fetch(`https://api.github.com/gists/${GIST_ID}`,{
    method:"PATCH",
    headers:{
      Authorization:`Bearer ${GITHUB_TOKEN}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      files:{
        [GIST_FILE]:{
          content:JSON.stringify(db,null,2)
        }
      }
    })
  });

  render();
}

/* ================= ADMIN ================= */

function adminResetLocal(){
  if(role!=="admin") return alert("Admin only");
  localStorage.removeItem("KEMITECH_DB");
  db={products:[],sales:[],expenses:[]};
  saveToCloud();
}

function adminResetApp(){
  if(role!=="admin") return alert("Admin only");
  db={products:[],sales:[],expenses:[]};
  saveToCloud();
}

/* ================= START ================= */

initDB();
</script>


<footer onclick="adminLogin()" style="opacity:.3;cursor:pointer;">Â© KemiTech</footer>
</body>
</html>
